document.addEventListener("DOMContentLoaded",()=>{MicroModal.init({openClass:"active",awaitCloseAnimation:!0,disableScroll:!0});let c=[],m=[],u=0,v={correct:!0,items:[]},g=[],o={id:null,source:null};var e=[document.getElementById("nav-create"),document.querySelector(".add-card")],R=document.getElementById("nav-review"),O=document.getElementById("nav-later");const D=document.querySelectorAll(".view"),d=document.getElementById("create-form"),P=document.getElementById("question"),r=document.getElementById("question-type"),l=document.getElementById("mc-options-container"),s=document.getElementById("mc-options-list"),y=document.getElementById("add-option-btn"),F=document.getElementById("answer"),p={answerElem:document.getElementById("answer-container"),itemsElem:document.getElementById("enum-items-container")},h=document.getElementById("enum-items-list"),U=document.getElementById("add-item-btn"),f=document.getElementById("alternatives-container"),E=document.getElementById("alternatives-list"),J=document.getElementById("add-alternative-btn"),n=document.getElementById("review-management-area"),G=document.getElementById("review-list"),z=document.getElementById("review-list-placeholder"),Y=document.getElementById("start-review-btn"),i=document.getElementById("review-card-container"),K=document.getElementById("review-progress"),Q=document.getElementById("review-question"),a=document.getElementById("review-answer-area"),w=document.getElementById("submit-answer-btn"),I=document.getElementById("next-card-btn"),B=document.getElementById("feedback-message"),V=document.getElementById("later-list"),W=document.getElementById("later-placeholder"),X=document.getElementById("review-later-btn");var Z=document.getElementById("import-btn");const b=document.getElementById("import-file-input");var _=document.getElementById("export-btn");const L=document.getElementById("edit-modal");var ee=document.getElementById("edit-form");document.getElementById("cancel-edit-btn");const te=document.getElementById("edit-card-id"),ne=document.getElementById("edit-card-source"),ie=document.getElementById("edit-question"),x=document.getElementById("edit-question-type"),ae=document.getElementById("edit-mc-options-container"),C=document.getElementById("edit-mc-options-list"),de=document.getElementById("edit-add-option-btn"),re=document.getElementById("edit-answer"),k={answerElem:document.getElementById("edit-answer-container"),itemsElem:document.getElementById("edit-enum-items-container")},le=document.getElementById("edit-enum-items-list"),oe=document.getElementById("edit-add-item-btn"),se=document.getElementById("edit-alternatives-container"),q=document.getElementById("edit-alternatives-list"),ce=document.getElementById("edit-add-alternative-btn"),me=(MicroModal.initModal(L,{}),document.getElementById("confirm-modal"));document.getElementById("cancel-remove-btn");var ue=document.getElementById("confirm-remove-btn");const ve=document.getElementById("alert-modal"),ge=document.getElementById("alert-message");function M(e){ge.textContent=e,MicroModal.show(ve)}function A(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return e.replace(/[&<>"']/g,e=>t[e])}function t(e){D.forEach(e=>e.classList.remove("active")),document.getElementById(e).classList.add("active");document.querySelectorAll(".nav-btn").forEach(e=>{e.classList.remove("active-tab","text-blue-600","border-b-2","border-blue-600"),e.classList.add("text-gray-500"),e.ariaSelected="false"});var t=document.getElementById("nav-"+e.split("-")[0]);t.classList.add("active-tab","text-blue-600","border-b-2","border-blue-600"),t.classList.remove("text-gray-500"),t.ariaSelected="true","review-view"===e?(n.style.display="block",i.classList.add("hidden"),$()):"later-view"===e&&j()}function ye(e,t,n){const i=document.createElement("div");i.className="input-wrapper";var a=document.createElement("input"),t=(a.type="text",a.className="dynamic-input flex-grow mt-1 block w-full rounded-md border-gray-300 shadow-sm custom-focus-ring sm:text-sm p-2",a.value=t,document.createElement("button"));t.type="button",t.innerHTML="&times;",t.className="text-red-500 font-bold text-2xl hover:text-red-700",t.onclick=()=>{"Choice"===n&&e.children.length<=2?M("A multiple choice question must have at least two choices."):"Item"===n&&e.children.length<=1?M("An enumeration question must have at least one item."):(i.remove(),S(e,n))},i.appendChild(a),i.appendChild(t),e.appendChild(i)}function S(e,n){e.querySelectorAll(".dynamic-input").forEach((e,t)=>{e.placeholder=n+" "+(t+1)})}function N(t,e,n,i=[]){t.innerHTML="",i.forEach(e=>ye(t,e,n)),S(t,n),e.onclick=()=>{ye(t,"",n),S(t,n)}}function T(e,t,n,i){t.classList.toggle("hidden","multiple-choice"!==e),n.classList.toggle("hidden","identification"!==e);t="enumeration"===e,i.answerElem.classList.toggle("hidden",t),i.itemsElem.classList.toggle("hidden",!t),n=i.answerElem.querySelector("input");n.required=!t,n.ariaRequired=!t}function pe(e,r,t,l){r.innerHTML="",0===e.length?t.style.display="block":(t.style.display="none",e.forEach(i=>{var e=document.createElement("div"),t=(e.className="bg-gray-50 p-3 rounded-lg border border-gray-200 flex justify-between items-center",document.createElement("p")),n=(t.textContent=i.question,t.className="truncate mr-4",document.createElement("div")),a=(n.className="flex-shrink-0 flex gap-2",document.createElement("button")),d=(a.textContent="Edit",a.className="text-sm font-medium text-blue-600 hover:text-blue-800",a.onclick=()=>{var t,e,n;t=i.id,(n=(n="flashcards"===(e=l)?c:m).find(e=>e.id===t))&&(te.value=t,ne.value=e,ie.value=n.question,x.value=n.type,T(n.type,ae,se,k),"enumeration"===n.type?(N(le,oe,"Item",n.answer||["","",""]),(e=document.getElementById("edit-enumeration-order")).checked=n.ordered||!1,e.ariaChecked=e.checked):re.value=n.answer,"multiple-choice"===n.type?N(C,de,"Choice",n.options||["",""]):"identification"===n.type&&N(q,ce,"Alternative",n.alternatives||[]),MicroModal.show(L))},document.createElement("button"));d.textContent="Remove",d.className="text-sm font-medium text-red-600 hover:text-red-800",d.onclick=()=>{return e=i.id,t=l,o={id:e,source:t},void MicroModal.show(me);var e,t},n.appendChild(a),n.appendChild(d),e.appendChild(t),e.appendChild(n),r.appendChild(e)}))}function $(){pe(c,G,z,"flashcards"),Y.classList.toggle("hidden",0===c.length)}function j(){pe(m,V,W,"forLater"),X.classList.toggle("hidden",0===m.length)}function H(){if(u>=g.length)n.style.display="block",i.classList.add("hidden"),$(),j();else{var t=g[u];K.textContent=u+1+" / "+g.length,Q.textContent=t.question,a.innerHTML="",B.innerHTML="",B.className="mt-4 font-medium p-3 rounded-lg";let e;if("multiple-choice"!==t.type)a.innerHTML='<input type="text" id="user-answer" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm custom-focus-ring sm:text-sm p-2">',e=document.getElementById("user-answer"),"enumeration"===t.type?e.placeholder="Answer 1 of "+t.answer.length:e.placeholder="Type your answer here...",e.focus();else{t=[...t.options].sort(()=>Math.random()-.5);let n='<div id="user-answer" class="space-y-2">';t.forEach((e,t)=>{n+=`<div class="flex items-center"><input id="mc-${t}" name="mc-answer" type="radio" value="${A(e)}" class="h-4 w-4 text-blue-600 border-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-300"><label for="mc-${t}" class="ml-3 block text-sm font-medium text-gray-700">${A(e)}</label></div>`}),n+="</div>",a.innerHTML=n,e=document.getElementById("user-answer"),document.getElementById("mc-0").focus()}e.addEventListener("keydown",function(e){"Enter"===e.key&&(e.preventDefault(),(w.classList.contains("hidden")?(u++,v={correct:!0,items:[]},H):he)())}),w.classList.remove("hidden"),I.classList.add("hidden")}}function he(){const t=g[u];let n;if(n="multiple-choice"!==t.type?document.getElementById("user-answer").value.trim():(a=document.querySelector('input[name="mc-answer"]:checked'))?a.value:"")if("enumeration"===t.type){var i=t,a=n,d=i.ordered||!1,r=i.answer.map(e=>e.toLowerCase()),l=document.getElementById("user-answer"),o=a.toLowerCase();if(!d&&v.items.includes(o))M(`You have already entered "${a}".`),l.value="";else{let e=!1;d?(s=v.items.length)<r.length&&o===r[s]&&(e=!0):r.includes(o)&&!v.items.includes(o)&&(e=!0);var s=document.createElement("div");s.className="inline-block bg-gray-50 m-1 p-1 rounded-md border border-gray-200",s.textContent=`${e?"✅":"❌"} `+a,s.classList.add(e?"text-green-600":"text-red-600"),v.items.push(o),e||(v.correct=!1),B.appendChild(s),(v.items.length>=i.answer.length?((r=document.createElement("div")).className="mt-2 font-medium p-3 rounded-lg",v.correct?(r.textContent="✅ All correct! Great job!",r.classList.add("bg-green-100","text-green-700"),-1<(a=c.findIndex(e=>e.id===i.id))&&(m.push(c[a]),c.splice(a,1))):(o=i.answer.map(e=>A(e)).join(d?" → ":", "),r.innerHTML=`Not quite. The correct answer${d?" sequence":"s are"}: <strong>${o}</strong>`,r.classList.add("bg-red-100","text-red-700")),B.appendChild(r),w.classList.add("hidden"),I.classList.remove("hidden"),I):(l.placeholder=`Answer ${v.items.length+1} of `+i.answer.length,l.value="",l)).focus()}}else{let e=!1;if(e="identification"===t.type?[t.answer,...t.alternatives||[]].map(e=>e.toLowerCase()).includes(n.toLowerCase()):n.toLowerCase()===t.answer.toLowerCase()){B.textContent="✅ Correct! Great job!",B.classList.add("bg-green-100","text-green-700");d=c.findIndex(e=>e.id===t.id);-1<d&&m.push(c.splice(d,1)[0])}else{let e=t.answer;"identification"===t.type&&t.alternatives&&0<t.alternatives.length&&(e=[t.answer,...t.alternatives].join(" / ")),B.innerHTML=`❌ Not quite. The correct answer is: <strong>${A(e)}</strong>`,B.classList.add("bg-red-100","text-red-700")}w.classList.add("hidden"),I.classList.remove("hidden"),I.focus()}else M("Please provide an answer.")}MicroModal.initModal(me,{}),MicroModal.initModal(ve,{}),e.forEach(e=>e.addEventListener("click",()=>t("create-view"))),R.addEventListener("click",()=>t("review-view")),O.addEventListener("click",()=>t("later-view")),r.addEventListener("change",()=>T(r.value,l,f,p)),x.addEventListener("change",()=>T(x.value,ae,se,k)),d.addEventListener("submit",e=>{e.preventDefault();var e=P.value.trim(),t=r.value,n={id:Date.now(),question:e,type:t,alternatives:[]};let i;if("enumeration"===t){if(i=[...p.itemsElem.querySelectorAll(".dynamic-input")].map(e=>e.value.trim()).filter(Boolean),!e||i.length<1)return void M("Please fill in the question and at least one item.");var a=document.getElementById("enumeration-order").checked;if(!a)if(new Set(i.map(e=>e.toLowerCase())).size!==i.length)return void M("For unordered enumerations, please make sure there are no duplicate items.");n.answer=i,n.ordered=a}else{if(i=F.value.trim(),!e||!i)return void M("Please fill in the question and answer.");n.answer=i}if("multiple-choice"===t){a=[...s.querySelectorAll(".dynamic-input")].map(e=>e.value.trim()).filter(Boolean);if(a.length<2)return void M("Please provide at least two choices.");if(!a.map(e=>e.toLowerCase()).includes(i.toLowerCase()))return void M("The correct answer must be one of the choices.");n.options=a}else"identification"===t&&(n.alternatives=[...E.querySelectorAll(".dynamic-input")].map(e=>e.value.trim()).filter(Boolean));c.push(n),M("Flashcard created!"),d.reset(),document.getElementById("enumeration-order").checked=!1,document.getElementById("enumeration-order").ariaChecked=!1,T("identification",l,f,p),N(s,y,"Choice",["",""]),N(h,U,"Item",["","",""]),N(E,J,"Alternative",[]),$()}),Y.addEventListener("click",function(){g=[...c].sort(()=>Math.random()-.5),u=0,v={correct:!0,items:[]},n.style.display="none",i.classList.remove("hidden"),H()}),w.addEventListener("click",he),I.addEventListener("click",()=>{u++,v={correct:!0,items:[]},H()}),X.addEventListener("click",()=>{c=[...c,...m],m=[],j(),$(),M("Cards moved back to the main review deck."),t("review-view")}),Z.addEventListener("click",()=>b.click()),_.addEventListener("click",()=>{var e,t;0===c.length&&0===m.length?M("No cards to export."):(e=JSON.stringify({flashcards:c,forLater:m},null,2),e=new Blob([e],{type:"application/json"}),e=URL.createObjectURL(e),(t=document.createElement("a")).href=e,t.download="flashcards.json",t.click(),URL.revokeObjectURL(e))}),b.addEventListener("change",e=>{var t,e=e.target.files[0];e&&((t=new FileReader).onload=e=>{try{var t=JSON.parse(e.target.result);Array.isArray(t.flashcards)&&Array.isArray(t.forLater)?(c=t.flashcards,m=t.forLater,$(),j(),M("Flashcards imported successfully!")):M("Invalid JSON file format.")}catch(e){M("Error reading or parsing the file.")}},t.readAsText(e),b.value="")}),ee.addEventListener("submit",e=>{e.preventDefault();const t=parseInt(te.value);var e=ne.value,n="flashcards"===e?c:m,i=n.findIndex(e=>e.id===t);if(-1!==i){var a={...n[i]};if(a.question=ie.value.trim(),a.type=x.value,a.alternatives=[],delete a.options,"enumeration"===a.type?(a.answer=[...k.itemsElem.querySelectorAll(".dynamic-input")].map(e=>e.value.trim()).filter(Boolean),a.ordered=document.getElementById("edit-enumeration-order").checked):a.answer=re.value.trim(),"multiple-choice"===a.type){var d=[...C.querySelectorAll(".dynamic-input")].map(e=>e.value.trim()).filter(Boolean);if(d.length<2)return void M("Please provide at least two choices.");if(!d.map(e=>e.toLowerCase()).includes(a.answer.toLowerCase()))return void M("The correct answer must be one of the choices.");a.options=d}else"identification"===a.type&&(a.alternatives=[...q.querySelectorAll(".dynamic-input")].map(e=>e.value.trim()).filter(Boolean));n[i]=a,MicroModal.close(L),("flashcards"===e?$:j)()}}),ue.addEventListener("click",()=>{let{id:t,source:e}=o;("flashcards"===e?(c=c.filter(e=>e.id!==t),$):(m=m.filter(e=>e.id!==t),j))()}),T("identification",l,f,p),N(s,y,"Choice",["",""]),N(h,U,"Item",["","",""]),N(E,J,"Alternative",[]),N(C,de,"Choice",["",""]),N(le,oe,"Item",["","",""]),N(q,ce,"Alternative",[]),t("create-view")});